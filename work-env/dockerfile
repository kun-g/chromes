# dev.Dockerfile
FROM tsl0922/ttyd:latest

USER root
SHELL ["/bin/bash", "-lc"]

# 检测系统并安装基础工具
RUN if command -v apk >/dev/null 2>&1; then \
      # Alpine Linux
      apk add --no-cache bash curl jq git openssh-client ca-certificates sudo && \
      apk add --no-cache --repository=https://dl-cdn.alpinelinux.org/alpine/edge/community aws-cli; \
    elif command -v apt-get >/dev/null 2>&1; then \
      # Debian/Ubuntu
      apt-get update && \
      apt-get install -y bash curl jq git openssh-client ca-certificates unzip sudo wget && \
      # AWS CLI v2 支持多架构
      ARCH=$(uname -m) && \
      if [ "$ARCH" = "x86_64" ]; then AWS_ARCH="x86_64"; \
      elif [ "$ARCH" = "aarch64" ]; then AWS_ARCH="aarch64"; \
      else echo "Unsupported arch for AWS CLI: $ARCH" && exit 1; fi && \
      echo "Downloading AWS CLI for ${AWS_ARCH}..." && \
      curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-${AWS_ARCH}.zip" -o "awscliv2.zip" && \
      unzip -q awscliv2.zip && ./aws/install >/dev/null 2>&1 && rm -rf aws awscliv2.zip && \
      echo "AWS CLI installed successfully" && \
      apt-get clean && rm -rf /var/lib/apt/lists/*; \
    elif command -v yum >/dev/null 2>&1; then \
      # CentOS/RHEL
      yum update -y && \
      yum install -y bash curl jq git openssh-clients ca-certificates unzip sudo && \
      echo "Downloading AWS CLI..." && \
      curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
      unzip -q awscliv2.zip && ./aws/install >/dev/null 2>&1 && rm -rf aws awscliv2.zip && \
      echo "AWS CLI installed successfully" && \
      yum clean all; \
    else \
      echo "Unsupported package manager" && exit 1; \
    fi

# 2) kubectl（按官方建议从上游下载二进制，自动匹配架构）
ARG KUBECTL_VERSION=
RUN ARCH="$(uname -m)"; \
    case "$ARCH" in \
      x86_64)  KARCH=amd64 ;; \
      aarch64) KARCH=arm64 ;; \
      *) echo "unsupported arch: $ARCH" && exit 1 ;; \
    esac && \
    VER=${KUBECTL_VERSION:-$(curl -L -s https://dl.k8s.io/release/stable.txt)} && \
    curl -L -o /usr/local/bin/kubectl "https://dl.k8s.io/release/${VER}/bin/linux/${KARCH}/kubectl" && \
    chmod +x /usr/local/bin/kubectl

# 3) Amazon Q CLI（按官方文档安装，支持 SSH/无头环境）
# 添加构建时间戳以避免缓存问题
ARG BUILD_DATE=unknown
RUN echo "Build date: $BUILD_DATE" && ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
      echo "Installing Amazon Q Developer CLI for x86_64..." && \
      # 先尝试检查 glibc 版本，如果不够新就使用 musl 版本
      if ldd --version 2>/dev/null | head -1 | grep -q "2\.\([3-9][4-9]\|[4-9][0-9]\)"; then \
        echo "Using glibc version..." && \
        QURL="https://desktop-release.q.us-east-1.amazonaws.com/latest/q-x86_64-linux.zip"; \
      else \
        echo "Using musl version for compatibility..." && \
        QURL="https://desktop-release.codewhisperer.us-east-1.amazonaws.com/latest/q-x86_64-linux-musl.zip"; \
      fi && \
      curl --proto '=https' --tlsv1.2 -sSf "$QURL" -o /tmp/q.zip && \
      unzip -q /tmp/q.zip -d /tmp && \
      # 运行官方安装脚本，设置环境变量进行全局安装
      Q_INSTALL_GLOBAL=1 /tmp/q/install.sh && \
      rm -rf /tmp/q.zip /tmp/q && \
      echo "Amazon Q installed successfully"; \
    elif [ "$ARCH" = "aarch64" ]; then \
      echo "Installing Amazon Q Developer CLI for ARM64 (musl version)..." && \
      curl --proto '=https' --tlsv1.2 -sSf \
        "https://desktop-release.codewhisperer.us-east-1.amazonaws.com/latest/q-aarch64-linux-musl.zip" \
        -o /tmp/q.zip && \
      unzip -q /tmp/q.zip -d /tmp && \
      # 运行官方安装脚本，设置环境变量进行全局安装
      Q_INSTALL_GLOBAL=1 /tmp/q/install.sh && \
      rm -rf /tmp/q.zip /tmp/q && \
      echo "Amazon Q installed successfully"; \
    else \
      echo "Amazon Q not supported for architecture: $ARCH"; \
    fi || echo "Amazon Q installation failed, continuing without it..."

# 默认工作目录与历史
ENV HOME=/home/dev \
    HISTFILE=/home/dev/.bash_history \
    PROMPT_COMMAND='history -a'
RUN mkdir -p /home/dev && chown -R 1000:1000 /home/dev

# 保持 ttyd 的入口不变；通过 compose 传参
USER 0
