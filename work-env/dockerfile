# dev.Dockerfile
FROM tsl0922/ttyd:latest

USER root
SHELL ["/bin/bash", "-lc"]

# 检测系统并安装基础工具
RUN if command -v apk >/dev/null 2>&1; then \
      # Alpine Linux
      apk add --no-cache bash curl jq git openssh-client ca-certificates && \
      apk add --no-cache --repository=https://dl-cdn.alpinelinux.org/alpine/edge/community aws-cli; \
    elif command -v apt-get >/dev/null 2>&1; then \
      # Debian/Ubuntu
      apt-get update && \
      apt-get install -y bash curl jq git openssh-client ca-certificates unzip && \
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
      unzip awscliv2.zip && ./aws/install && rm -rf aws awscliv2.zip && \
      apt-get clean && rm -rf /var/lib/apt/lists/*; \
    elif command -v yum >/dev/null 2>&1; then \
      # CentOS/RHEL
      yum update -y && \
      yum install -y bash curl jq git openssh-clients ca-certificates unzip && \
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
      unzip awscliv2.zip && ./aws/install && rm -rf aws awscliv2.zip && \
      yum clean all; \
    else \
      echo "Unsupported package manager" && exit 1; \
    fi

# 2) kubectl（按官方建议从上游下载二进制，自动匹配架构）
ARG KUBECTL_VERSION=
RUN ARCH="$(uname -m)"; \
    case "$ARCH" in \
      x86_64)  KARCH=amd64 ;; \
      aarch64) KARCH=arm64 ;; \
      *) echo "unsupported arch: $ARCH" && exit 1 ;; \
    esac && \
    VER=${KUBECTL_VERSION:-$(curl -L -s https://dl.k8s.io/release/stable.txt)} && \
    curl -L -o /usr/local/bin/kubectl "https://dl.k8s.io/release/${VER}/bin/linux/${KARCH}/kubectl" && \
    chmod +x /usr/local/bin/kubectl

# Note: Amazon Q CLI installation removed due to unavailable download URL
# To install Amazon Q CLI, use the official installation method from AWS documentation

# 默认工作目录与历史
ENV HOME=/home/dev \
    HISTFILE=/home/dev/.bash_history \
    PROMPT_COMMAND='history -a'
RUN mkdir -p /home/dev && chown -R 1000:1000 /home/dev

# 保持 ttyd 的入口不变；通过 compose 传参
USER 0
