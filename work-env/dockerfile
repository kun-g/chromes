# dev.Dockerfile
FROM tsl0922/ttyd:latest

USER root
SHELL ["/bin/bash", "-lc"]

# 检测系统并安装基础工具
RUN if command -v apk >/dev/null 2>&1; then \
      # Alpine Linux
      apk add --no-cache bash curl jq git openssh-client ca-certificates sudo && \
      apk add --no-cache --repository=https://dl-cdn.alpinelinux.org/alpine/edge/community aws-cli; \
    elif command -v apt-get >/dev/null 2>&1; then \
      # Debian/Ubuntu
      apt-get update && \
      apt-get install -y bash curl jq git openssh-client ca-certificates unzip sudo wget && \
      # AWS CLI v2 支持多架构
      ARCH=$(uname -m) && \
      if [ "$ARCH" = "x86_64" ]; then AWS_ARCH="x86_64"; \
      elif [ "$ARCH" = "aarch64" ]; then AWS_ARCH="aarch64"; \
      else echo "Unsupported arch for AWS CLI: $ARCH" && exit 1; fi && \
      curl "https://awscli.amazonaws.com/awscli-exe-linux-${AWS_ARCH}.zip" -o "awscliv2.zip" && \
      unzip awscliv2.zip && ./aws/install && rm -rf aws awscliv2.zip && \
      apt-get clean && rm -rf /var/lib/apt/lists/*; \
    elif command -v yum >/dev/null 2>&1; then \
      # CentOS/RHEL
      yum update -y && \
      yum install -y bash curl jq git openssh-clients ca-certificates unzip sudo && \
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
      unzip awscliv2.zip && ./aws/install && rm -rf aws awscliv2.zip && \
      yum clean all; \
    else \
      echo "Unsupported package manager" && exit 1; \
    fi

# 2) kubectl（按官方建议从上游下载二进制，自动匹配架构）
ARG KUBECTL_VERSION=
RUN ARCH="$(uname -m)"; \
    case "$ARCH" in \
      x86_64)  KARCH=amd64 ;; \
      aarch64) KARCH=arm64 ;; \
      *) echo "unsupported arch: $ARCH" && exit 1 ;; \
    esac && \
    VER=${KUBECTL_VERSION:-$(curl -L -s https://dl.k8s.io/release/stable.txt)} && \
    curl -L -o /usr/local/bin/kubectl "https://dl.k8s.io/release/${VER}/bin/linux/${KARCH}/kubectl" && \
    chmod +x /usr/local/bin/kubectl

# 3) Amazon Q CLI（支持多架构）
RUN if command -v apt-get >/dev/null 2>&1; then \
      # Ubuntu/Debian 系统安装 Amazon Q
      ARCH=$(uname -m) && \
      if [ "$ARCH" = "x86_64" ]; then \
        # x86_64 使用 DEB 包
        curl --proto '=https' --tlsv1.2 -sSf \
          https://desktop-release.q.us-east-1.amazonaws.com/latest/amazon-q.deb \
          -o /tmp/amazon-q.deb && \
        apt-get update && \
        apt-get install -y /tmp/amazon-q.deb && \
        rm /tmp/amazon-q.deb && \
        apt-get clean && rm -rf /var/lib/apt/lists/*; \
      elif [ "$ARCH" = "aarch64" ]; then \
        # ARM64 使用 ZIP 包
        curl --proto '=https' --tlsv1.2 -sSf \
          "https://desktop-release.q.us-east-1.amazonaws.com/latest/q-aarch64-linux.zip" \
          -o /tmp/q.zip && \
        unzip /tmp/q.zip -d /opt/amazon-q && \
        ln -s /opt/amazon-q/q /usr/local/bin/q && \
        rm /tmp/q.zip; \
      else \
        echo "Unsupported architecture for Amazon Q: $ARCH"; \
      fi; \
    elif command -v apk >/dev/null 2>&1; then \
      # Alpine Linux 使用 musl 版本
      ARCH=$(uname -m) && \
      if [ "$ARCH" = "x86_64" ]; then \
        curl --proto '=https' --tlsv1.2 -sSf \
          "https://desktop-release.codewhisperer.us-east-1.amazonaws.com/latest/q-x86_64-linux-musl.zip" \
          -o /tmp/q.zip && \
        unzip /tmp/q.zip -d /opt/amazon-q && \
        ln -s /opt/amazon-q/q /usr/local/bin/q && \
        rm /tmp/q.zip; \
      else \
        echo "Amazon Q not available for Alpine $ARCH"; \
      fi; \
    else \
      echo "Amazon Q installation skipped for this distribution"; \
    fi

# 默认工作目录与历史
ENV HOME=/home/dev \
    HISTFILE=/home/dev/.bash_history \
    PROMPT_COMMAND='history -a'
RUN mkdir -p /home/dev && chown -R 1000:1000 /home/dev

# 保持 ttyd 的入口不变；通过 compose 传参
USER 0
